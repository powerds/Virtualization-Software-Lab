---
layout: post
title:  "Helm"
date:   2018-04-13 11:00:00 +0900
author: "김대성"
---

<p>by 김대성(<a href="mailto:daeseong.kim@sk.com">daeseong.kim@sk.com</a>)</p>

## Intro
 SK텔레콤의 클라우드 인프라 플랫폼 TACO는 지난 첫 포스트에서도 소개했지만 매우 다양한 오픈소스들로 이루어져 있습니다.
물론 그냥 가져다가 사용만 하는 것이 아니라 코드 기여 및 지속적인 미팅을 통해서 오픈소스 기술들을 내재화하고 있구요.
TACO는 Openstack을 Kubernetes위에 배포하기 위해서 Helm이라는 도구를 사용합니다.
그리고 이번 포스팅에서는 그 Helm에 대해서 자세히 이야기해 보도록 하겠습니다.

## Helm 이란?
 Helm은 deis라는 회사에서 시작한 Helm Classic프로젝트와 Google에서 진행되던 GCS Deployment Manager 프로젝트가 합해진 프로젝트입니다.
 Helm Classic은 Kubernetes에 어플리케이션을 올리고 관리하는 툴이고 GCS Deployment Manager는 Kubernetes의 어머니격인 Google Cloud에 어플리케이션을 배포하고 관리하는 툴이기 때문에 손을 잡을 수 있었던 것 같습니다.
 그렇게 deis와 google의 협업으로 진행되던 Helm 프로젝트는 CNCF의 한 프로젝트로 완전히 오픈소스화가 되었습니다.

 Helm은 Charts를 관리하며 이를 이용해서 어플리케이션을 Kubernetes 위에 배포하고 이렇게 배포된 어플리케이션을 관리합니다.
Charts란 Kubernetes에 올라갈 어플리케이션이 Kubernetes에 어떤 형태로 배포되는지, 어떤 자원들을 생성하고 사용하는지에 대한 정의가 담긴 설정의 집합이라 할 수 있습니다. 이번 포스팅에서는 Helm 뿐만 아니라 Charts를 어떻게 개발하는지에 대해서도 이야기해 볼 예정입니다.

Project Links
* Helm Code: https://github.com/Kubernetes/helm
* Charts Code: https://github.com/Kubernetes/Charts
* Documentation: https://docs.helm.sh

## Helm 구조
 helm은 client-server 구조로 설계되어 있습니다. 사용자를 위한 CLI인 client를 helm client라 부르고 server는 tiller라고 부릅니다. tiller는 보통kubernetes위에 pod으로 배포됩니다.
 그리고 kubernetes 위에 배포할 어플리케이션의 정의 및 설정 묶음을 chart라고 부릅니다. helm client를 통해서 chart를 kubernetes 위에 배포하면 배포된 어플리케이션을 release라고 부릅니다.

![Helm아키텍쳐]({{ site.baseurl }}{{ post.url }}/assets/img/helm/helm-architecture.png)
[![License: CC BY-NC-ND 4.0](https://licensebuttons.net/l/by-nc-nd/4.0/80x15.png)](https://creativecommons.org/licenses/by-nc-nd/4.0/)

* helm client : 사용자를 위한 CLI tool
* tiller : kubernetes 위에 배포된 helm server
* chart : 어플리케이션의 정의 및 설정 묶음
* release : kubernetes위에 배포된 어플리케이션

 helm client는 gRPC 프로토콜을 이용해서 tiller와 통신합니다. 사용자가 chart를 배포하기 위해 helm install 명령을 사용하면 helm client는 chart를 tiller에게 보냅니다. tiller는 받은 chart를 rendering해서 kubernetes api를 통해서 kubernetes 위에 어플리케이션을 배포합니다. 

 또한 helm client는 local 혹은 원격에 존재하는 chart repository들을 관리합니다. helm을 설치하면 기본적으로 stable reposiroty가 제공되고 여기엔 쉽게 배포해 볼 수 있는 다양한 어플리케이션들이 미리 준비되어 있습니다.

```bash
root@taco-aio:~# helm search
NAME                                 	CHART VERSION	APP VERSION                 	DESCRIPTION                                       
stable/acs-engine-autoscaler         	2.1.4        	2.1.1                       	Scales worker nodes within agent pools            
stable/aerospike                     	0.1.7        	v3.14.1.2                   	A Helm chart for Aerospike in Kubernetes          
stable/anchore-engine                	0.1.5        	0.1.9                       	Anchore container analysis and policy evaluatio...
stable/artifactory                   	7.1.0        	5.9.1                       	Universal Repository Manager supporting all maj...
stable/artifactory-ha                	0.1.5        	5.9.1                       	Universal Repository Manager supporting all maj...
stable/aws-cluster-autoscaler        	0.3.3        	                            	Scales worker nodes within autoscaling groups.    
stable/bitcoind                      	0.1.3        	0.15.1                      	Bitcoin is an innovative payment network and a ...
stable/buildkite                     	0.2.2        	3                           	Agent for Buildkite                               
stable/burrow                        	0.4.3        	0.17.1                      	Burrow is a permissionable smart contract machine 
stable/centrifugo                    	2.0.1        	1.7.3                       	Centrifugo is a real-time messaging server.       
stable/cert-manager                  	0.2.8        	0.2.4                       	A Helm chart for cert-manager                     
stable/chaoskube                     	0.7.0        	0.8.0                       	Chaoskube periodically kills random pods in you...
stable/chartmuseum                   	1.2.0        	0.5.1                       	Helm Chart Repository with support for Amazon S...
stable/chronograf                    	0.4.3        	1.3                         	Open-source web application written in Go and R...
stable/cluster-autoscaler            	0.5.3        	1.1.0                       	Scales worker nodes within autoscaling groups.    
stable/cockroachdb                   	1.0.4        	2.0.0                       	CockroachDB is a scalable, survivable, strongly...
stable/concourse                     	1.2.3        	3.10.0                      	Concourse is a simple and scalable CI system.     
stable/consul                        	1.3.5        	1.0.0                       	Highly available and distributed service discov...
stable/coredns                       	0.9.0        	1.0.6                       	CoreDNS is a DNS server that chains plugins and...
stable/coscale                       	0.2.1        	3.9.1                       	CoScale Agent                                     
stable/dask                          	1.0.2        	0.17.1                      	Distributed computation in Python with task sch...
stable/dask-distributed              	2.0.2        	                            	DEPRECATED: Distributed computation in Python     
stable/datadog                       	0.11.2       	6.1.2                       	DataDog Agent                                     
stable/dex                           	0.1.0        	2.10.0                      	CoreOS Dex                                        
stable/docker-registry               	1.1.1        	2.6.2                       	A Helm chart for Docker Registry                  
stable/dokuwiki                      	1.0.1        	0.20170219.201708232029     	DokuWiki is a standards-compliant, simple to us...
stable/drupal                        	0.11.15      	8.5.1                       	One of the most versatile open source content m...
stable/elastalert                    	0.1.3        	0.1.29                      	ElastAlert is a simple framework for alerting o...
stable/elasticsearch-exporter        	0.1.3        	1.0.2                       	Elasticsearch stats exporter for Prometheus       
stable/etcd-operator                 	0.7.5        	0.7.0                       	CoreOS etcd-operator Helm chart for Kubernetes    
stable/ethereum                      	0.1.1        	v1.7.3                      	private Ethereum network Helm chart for Kubernetes
stable/external-dns                  	0.5.4        	0.4.8                       	Configure external DNS servers (AWS Route53, Go...
stable/factorio                      	0.3.1        	0.14.22                     	Factorio dedicated server.                        
stable/filebeat                      	0.2.0        	6.2.3                       	A Helm chart to collect Kubernetes logs with fi...
stable/fluent-bit                    	0.4.0        	0.12.15                     	Fast and Lightweight Log/Data Forwarder for Lin...
...
```

## Installing Helm
 helm을 직접 사용해보려면 일단 kubernetes가 설치된 환경이 있어야 합니다. 그리고 그 위에 helm을 설치해야 합니다.

CentOS, Ubuntu, Redhat OS가 설치된 환경이 이미 있다면 taco-scripts를 통해서 쉽게 kubernetes 및 helm을 설치할 수 있습니다.

참고링크 : https://github.com/sktelecom-oslab/taco-scripts

위의 링크에서 020-install-k8s.sh 까지 스크립트를 진행하면 kubernetes가 설치되고 helm도 설치되는 것을 볼 수 있습니다.

020-install-k8s.sh 스크립트 중 아래 라인이 helm을 설치하는 부분입니다.
```bash
curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get | cat > /tmp/helm_script.sh \
&& chmod 755 /tmp/helm_script.sh && /tmp/helm_script.sh --version v2.8.2

helm init --upgrade
```
helm은 쉽게 설치할 수 있는 스크립트를 이미 제공하고 있고 taco-script에선 이 스크립트를 다운받아서 version을 명시해서 설치해주고 있습니다.
그리고 helm init --upgrade 명령어를 통해서 tiller를 kubernetes cluster위에 설치합니다. --upgrade 옵션은 이미 낮은 버젼 tiller가 설치되어 있다면 upgrade를 해주는 옵션입니다.

## Using Helm



 이런 서비스를 개발하면서 그에 대한 안정성 테스트를 생각하게 됩니다. 분산 서비스를 하는 이유는 속도 개선도 있지만 서버 한대가 이상이 생겨도 나머지 서버들이 서비스를 안전하게 동작시키기 위함입니다. 때문에 전통적인 기능, 성능 테스트뿐 아니라 장애 테스트를 추가하게됩니다.

 장애 테스트를 하려면 다음을 규정해야 합니다.

1. 정상 상태에 대한 규정 - 정상이라고 판단하기 위해 동작해야 하는 기능 리스트
2. 장애 발생 변수에 대한 규정 - 서비스의 구성요소(하드웨어, 네트워크, 스토리지 장애 및 OS 장애 등등)

 위 두가지를 정의했다면 이제 정상 상태의 서비스에 장애를 발생시키면서 서비스가 정상 작동하는지 검증해야합니다. 이는 실제로 일어날 수 있는 상황들을 가정하기 때문에 운영을 하기 위해 꼭 필요한 테스트입니다. 서비스 운영 시 발생하는 장애 요인을 미리 제거하는 이러한 활동을 카오스 엔지니어링<sup name="a1">[1](#f1)</sup>이라고 합니다.


![TACO CI/CD]({{ site.baseurl }}{{ post.url }}/assets/img/cookiemonster/taco-cicd.png)
[![License: CC BY-NC-ND 4.0](https://licensebuttons.net/l/by-nc-nd/4.0/80x15.png)](https://creativecommons.org/licenses/by-nc-nd/4.0/)

 위 그림은 내부에 구축한 CI/CD Pipeline에 대한 구성도입니다. OpenStack Container 빌드 혹은 Helm Chart 빌드 때마다 그림에 표시된 "Integration Test"단계에서 아래에서 설명할 장애테스트를 수행하여 TACO 서비스의 안정성을 검증하고 있습니다. 이 글에서는 TACO에서 사용하는 장애 발생 툴인 Cookiemonster와 장애 테스트에 대해 설명합니다. TACO CI/CD에 대해서는 따로 포스트를 작성할 예정입니다.

## Kubernetes 구조
 TACO는 Kubernetes위에 구축된 OpenStack 서비스로 TACO를 알기 위해서는 Kubernetes의 이해가 필요합니다. Kubernetes의 대한 내용은 [이전 글]({{ site.baseurl }}{{ post.url }}/Taco/#kubernetes)을 참고하시기 바랍니다.

## 장애 발생 툴
 Kubernetes환경에서 사용하는 장애 발생 툴은 여러가지가 있습니다. 대부분 넷플릭스의 카오스몽키의 영감을 갖고 만들어졌으며, 각자 Kubernetes 환경에 대한 장애를 발생시킵니다.

- kube-monkey
- chaoskube
- powerfulseal

| Tools         | Repo                                      | 실행방법          |
| ------------- |------------------------------------------ | ----------------- |
| kube-monkey   | https://github.com/asobti/kube-monkey     | Install template  |
| chaoskube     | https://github.com/linki/chaoskube        | Command Line      |
| powerfulseal  | https://github.com/bloomberg/powerfulseal | Command Line      |

## Cookiemonster
 Cookiemonster는 SKT에서 개발한 Apache 2.0 라이센스의 오픈소스 프로젝트로 TACO의 CI/CD에서 사용하고 있는 Kubernetes용 장애발생툴입니다. 또한, 구축된 TACO에 대한 장애테스트 용도로도 사용할 수 있습니다.
   - Project Code: <https://github.com/sktelecom-oslab/cookiemonster>

 아래 구성도에 표시된 것 처럼 Cookiemonster pod와 worker pod으로 구성되며 다음 역할을 수행합니다.
![Cookiemonster 구성]({{ site.baseurl }}{{ post.url }}/assets/img/cookiemonster/cookiemonster.png)
[![License: CC BY-NC-ND 4.0](https://licensebuttons.net/l/by-nc-nd/4.0/80x15.png)](https://creativecommons.org/licenses/by-nc-nd/4.0/)
- Cookiemonster pod: REST API 서버, 외부로부터 요청을 받고 worker pod과 통신
- worker pod: cookiemonster pod으로부터 받은 요청 수행, 실질적인 장애 발생

### 개발이유
 기존 장애 유발 툴들은 테스트를 백그라운드가 아닌 포어그라운드에서 수행합니다. 때문에 장애를 내고 있는 화면이 아닌 다른 곳에서 검증을 수행해야하는데 이는 저희가 사용하는 Jenkins에 적합하지 않았습니다. (Jenkins에서 parallel 작업을 지원하지만 깔끔하게 적용하기가 어려웠습니다.) 만약에 테스트가 백그라운드로 수행된다면, Jenkins 내에서 장애를 발생시킨 후 바로 검증 작업을 수행할 수 있을 것입니다. Cookiemonster는 이러한 필요에 의해 REST API로 서비스 요청을 수행하며 백그라운드로 장애발생을 시작/중단하여 손쉽게 Jenkins Job으로 적용할 수 있습니다.  

### 설치방법
 github 저장소에서 Cookiemonster를 다운로드 받습니다.

```bash
taco@ctrl01-stg:~$ git clone https://github.com/sktelecom-oslab/cookiemonster.git
taco@ctrl01-stg:~$ cd cookiemonster
```
 kubectl로 k8s폴더에 있는 템플릿을 설치합니다.

```bash
taco@ctrl01-stg:~/cookiemonster$ kubectl create ns cookiemonster
taco@ctrl01-stg:~/cookiemonster$ kubectl create -f ./k8s
taco@ctrl01-stg:~/cookiemonster$ kubectl get po -n cookiemonster
NAME                             READY     STATUS    RESTARTS   AGE
cookiemonster-7dfdf5d77d-blscj   1/1       Running   0          2s
cookiemonsterworker-7tk4f        1/1       Running   0          3s
cookiemonsterworker-gd924        1/1       Running   0          3s
cookiemonsterworker-k7vrc        1/1       Running   0          3s
cookiemonsterworker-k8lzz        1/1       Running   0          3s
cookiemonsterworker-kccdm        1/1       Running   0          3s
cookiemonsterworker-lmzbc        1/1       Running   0          3s
cookiemonsterworker-lwtcv        1/1       Running   0          3s
cookiemonsterworker-rhnsj        1/1       Running   0          3s
```

 cookiemonster pod이 제대로 배포되지 않았다면 ```kubectl create -f ./k8s```을 한번 더 수행합니다.

### 사용방법
 cookiemonster는 30003 포트로 API 요청을 처리합니다. 포트 정보는 아래 명령으로 확인합니다.

```bash
taco@ctrl01-stg:~/cookiemonster$ kubectl get svc -n cookiemonster
NAME            TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
cookiemonster   NodePort   10.96.34.201   <none>        8080:30003/TCP   30s
```

 kubernetes 노드 중 한 곳의 IP:30003로 API를 요청합니다.

```bash
taco@ctrl01-stg:~/cookiemonster$ curl localhost:30003/list
killpod
nodeexec

taco@ctrl01-stg:~$ curl localhost:30003/list/killpod
openstack-random-daemonset
openstack-random-deployment
openstack-random-statefulset
```

 현재 cookiemonster는 killpod API만 제공하며 1분에 한번씩 pod을 random하게 파괴시킵니다.  openstack으로 시작하는 API 내용은 cookiemonster/cookies.d/killpod 폴더에서 확인할 수 있습니다.

```bash
taco@ctrl01-stg:~/cookiemonster$ cat cookies.d/killpod/openstack-random-deployment.json
{
  "kind": "deployment",
  "namespace": "openstack",
  "target": 1,
  "interval": 30,
  "duration": 600,
  "slack": false
}
```

 openstack-random-deployment.json의 경우 openstack 네임스페이스에 있는 deployment를 30초에 한번씩 랜덤하게 파괴시킵니다. json에 명시된 값은 모두 변경 가능합니다.

#### 장애 발생
 이제 장애 발생 API를 호출해보도록 하겠습니다.

```bash
taco@ctrl01-stg:~$ curl localhost:30003/start/killpod/openstack-random-deployment
start initiated
```

 cookiemonster pod의 로그를 확인합니다. 30초마다 랜덤하게 deployment를 파괴시키고 있습니다.

~~~
taco@ctrl01-stg:~$ kubectl logs cookiemonster-7dfdf5d77d-blscj -n cookiemonster -f
2018/02/28 04:27:49 checking directory:  /cookies.d
2018/02/28 04:27:49 checking directory:  /etc/cookies.d
2018/02/28 04:27:49 loading  /etc/cookies.d/killpod/openstack-random-deployment.json
2018/02/28 04:27:49 Cookie Time!!! Random feast starting on deployment in namespace openstack
2018/02/28 04:28:19 Running in Kubernetes cluster
2018/02/28 04:28:19 deployment etcd in namespace openstack has 1 pods defined, 1 available and 0 unavailable
2018/02/28 04:28:19 Only one pod available, doing nothing
2018/02/28 04:28:49 Running in Kubernetes cluster
2018/02/28 04:28:49 deployment horizon in namespace openstack has 3 pods defined, 3 available and 0 unavailable
2018/02/28 04:28:49 Found deployment horizon in namespace openstack
2018/02/28 04:28:49 Eating pod horizon-796f7b5f5-fn7mn NOM NOM NOM!!!!
2018/02/28 04:29:19 Running in Kubernetes cluster
2018/02/28 04:29:19 deployment glance-api in namespace openstack has 3 pods defined, 3 available and 0 unavailable
2018/02/28 04:29:19 Found deployment glance-api in namespace openstack
2018/02/28 04:29:19 Eating pod glance-api-59ff964c7b-p6k8d NOM NOM NOM!!!!
2018/02/28 04:29:49 Running in Kubernetes cluster
2018/02/28 04:29:49 deployment cinder-backup in namespace openstack has 1 pods defined, 1 available and 0 unavailable
2018/02/28 04:29:49 Only one pod available, doing nothing
~~~

#### 장애 중단
 장애 중단 API는 다음과 같습니다.

```bash
taco@ctrl01-stg:~$ curl localhost:30003/stop/killpod/openstack-random-deployment
stop initiated
```

 cookiemonster pod의 로그를 확인합니다. 장애 발생이 중단된 것을 볼 수 있습니다.

```bash
taco@ctrl01-stg:~$ kubectl logs cookiemonster-7dfdf5d77d-blscj -n cookiemonster -f
2018/02/28 04:30:37 checking directory:  /cookies.d
2018/02/28 04:30:37 checking directory:  /etc/cookies.d
2018/02/28 04:30:37 loading  /etc/cookies.d/killpod/openstack-random-deployment.json
2018/02/28 04:30:37 Done snacking on openstack-random-deployment
```

## 장애테스트 방법
 TACO CI/CD의 장애테스트는 다음의 구조로 실행됩니다. Cookiemonster를 통해 장애를 발생시키고 Rally를 통해 검증하는 방식입니다.

* 배포 - OpenStack 서비스를 분산 구조로 배포
* Cookiemonster 설치/실행 - OpenStack 서비스 장애 발생
* Rally 테스트 실행 - OpenStack 서비스의 정상작동 확인
* Cookiemonster 중단 - OpenStack 서비스 장애 중단

![장애테스트 Pipeline]({{ site.baseurl }}{{ post.url }}/assets/img/cookiemonster/hatest.png)
[![License: CC BY-NC-ND 4.0](https://licensebuttons.net/l/by-nc-nd/4.0/80x15.png)](https://creativecommons.org/licenses/by-nc-nd/4.0/)

## 마무리

 장애테스트는 서비스 안정성을 검증하기 위해 꼭 수행해야 하는 테스트입니다. Kubernetes를 구축하고 이 위에 서비스를 배포하였다면 장애 유발 테스트 툴을 사용하여 장애 환경을 시뮬레이션할 수 있습니다. 여러 장애 유발 테스트툴을 사용해보고 가장 적합한 테스트 툴을 찾아야할 것입니다. 마지막으로 Cookiemonster에도 관심이 있으신 분은 github을 통해서 개발에 참여하거나 이슈를 남겨주시면 좋겠습니다.



참고
<b><a name="f1">[1](#a1)</a></b> 카오스 엔지니어링: http://principlesofchaos.org http://channy.creation.net/blog/1173
